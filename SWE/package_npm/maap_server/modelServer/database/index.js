/** * File: index.js * Module: maap_server::modelServer::database * Author: Alberto Garbui * Created: 12/05/14 * Version: 0.1 * Description: inizializzazione database * Modification History: ============================================== * Version | Changes ============================================== * 0.1 File creation ============================================== */'use strict';var mongoose = require('mongoose');var userDBManager = require('./MongooseDBFramework');var dataDBManager = require('./MongooseDBAnalysis');var addAdminDefault = function(config, userDB){	var collection = config.userDB.usersCollection;	var usersModel = require('./MongooseDBFramework').users;	var dataRetriever = require('../dataManager/DatabaseUserManager/DataRetrieverUsers');	var emailDefault = 'admin@admin.com';	var passwordDefault = 'password';	var levelDefault = 1;	userDB.db.collectionNames(collection, function(err, names){		if(err)			console.log('Errore controllo collection utenti. '+err);		if(names.length == 0){			dataRetriever.addUser(emailDefault, passwordDefault, levelDefault, function(done){				if(done)					console.log('Email di default: '+emailDefault+ '\nPassword di default: '+passwordDefault);			});		}//if		});}var initDB = function(app) {	var config = app.config;		console.log('databases init... ');	var userDB2connect = 'mongodb://' + config.userDB.host + ':' + config.userDB.port + "/" + config.userDB.db_name;		console.log('connecting to user db: ' + userDB2connect + ' ...');		//createConnection usato per creare connessioni multiple a diversi db	var userDB = mongoose.createConnection(userDB2connect);		app.db = {};	app.db.users = userDB;		userDB.on('error', console.error.bind(console, 'connection failed! check your users\'s mongodb path!\n'));	userDB.once('open', function callback() {		console.log('successfully connected to user\'s database!');		userDBManager.init(app);		addAdminDefault(config, userDB);	});			var analysisDB2connect = 'mongodb://' + config.dataDB.host + ':' + config.dataDB.port + "/" + config.dataDB.db_name;		console.log('connecting to data db: ' + analysisDB2connect + ' ...');		var dataDB = mongoose.createConnection(analysisDB2connect);		app.db.data = dataDB;		dataDB.on('error', console.error.bind(console, 'connection failed! check your data\'s mongodb path!\n'));	dataDB.once('open', function callback() {		console.log('successfully connected to data\'s database!');			dataDBManager.init(app);	});}exports.init = initDB;